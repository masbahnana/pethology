<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - Pethology</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <style>
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      text-align: center;
    }

    .login-header {
      margin-bottom: 30px;
    }

    .login-header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #111;
    }

    .login-header p {
      color: #666;
      font-size: 1rem;
    }

    .microsoft-login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 15px 20px;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      margin-bottom: 10px;
    }

    .microsoft-login-btn:hover {
      background-color: #106ebe;
      transform: translateY(-1px);
    }

    .google-login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 15px 20px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .google-login-btn:hover {
      background-color: #3367d6;
      transform: translateY(-1px);
    }

    .divider {
      margin: 20px 0;
      color: #999;
      font-size: 0.9rem;
    }

    .loading {
      display: none;
      margin-top: 20px;
      color: #666;
    }

    .error-message {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #fee;
      border: 1px solid #fcc;
      border-radius: 8px;
      color: #c33;
    }

    .success-message {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #efe;
      border: 1px solid #cfc;
      border-radius: 8px;
      color: #363;
    }

    .demo-users {
      margin-top: 30px;
      padding: 20px;
      background: #fff9e6;
      border-radius: 8px;
      border: 1px solid #ffd700;
    }

    .demo-users h4 {
      margin-top: 0;
      color: #b8860b;
    }

    .demo-button {
      display: inline-block;
      margin: 5px;
      padding: 8px 16px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      text-decoration: none;
      color: #333;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .demo-button:hover {
      background: #e0e0e0;
    }

    .info-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      text-align: left;
    }

    .info-section h3 {
      margin-top: 0;
      color: #111;
      font-size: 1.1rem;
    }

    .info-section ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .info-section li {
      margin-bottom: 5px;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Pethology</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="students.html">For Students</a></li>
        <li><a href="teachers.html">For Teachers</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="login-container">
      <div class="login-header">
        <h1>Welcome to Pethology!</h1>
        <p>Sign in to access your personalized learning experience</p>
      </div>

      <button class="microsoft-login-btn" onclick="loginWithMicrosoft()">
        <svg width="20" height="20" viewBox="0 0 23 23" fill="currentColor">
          <path d="M1 1h10v10H1zM12 1h10v10H12zM12 12h10v10H12zM1 12h10v10H1z"/>
        </svg>
        Sign in with Microsoft 365
      </button>

      <div class="divider">or</div>

      <button class="google-login-btn" onclick="loginWithGoogle()">
        <svg width="20" height="20" viewBox="0 0 24 24">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Sign in with Google
      </button>

      <div id="loading" class="loading">
        <p>Signing you in...</p>
      </div>

      <div id="error" class="error-message"></div>
      <div id="success" class="success-message"></div>

      <div class="info-section">
        <h3>‚úÖ Supported Accounts</h3>
        <ul>
          <li><strong>Students:</strong> School email (@stconlethcc365.ie)</li>
          <li><strong>Teachers:</strong> Staff email (@staff.school.ie)</li>
          <li><strong>Personal:</strong> Google, Outlook, Hotmail</li>
        </ul>
      </div>

      <!-- Demo users for testing -->
      <div class="demo-users">
        <h4>üß™ Demo Mode</h4>
        <p>For testing and development:</p>
        <button class="demo-button" onclick="createDemoUser('student')">Demo Student</button>
        <button class="demo-button" onclick="createDemoUser('teacher')">Demo Teacher</button>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 Pethology ‚Äî Built with ‚ù§Ô∏è by Animal Care Nerds
  </footer>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>

  <!-- Firebase SDK for database -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // FIREBASE CONFIG (para banco de dados)
    const firebaseConfig = {
        apiKey: "AIzaSyDYq8xnfL9KPiKYHHvDG1zHDvjd4WAOO3o",
        authDomain: "pethology-7e9d7.firebaseapp.com",
        projectId: "pethology-7e9d7",
        storageBucket: "pethology-7e9d7.firebasestorage.app",
        messagingSenderId: "485201789422",
        appId: "1:485201789422:web:309a54ceb82588973f0eff"
    };

    // Inicializar Firebase (s√≥ para dados)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.firebaseDb = db;

    // AUTH0 CONFIG
    const auth0Config = {
      domain: 'dev-itl78pbpxq46x8gh.eu.auth0.com',  // Substituir pelo seu domain
      clientId: 'uKYMTC50M5fOy3LemUcRnzNYCSgigclj',        // Substituir pelo seu client ID
      authorizationParams: {
        redirect_uri: window.location.origin + '/auth0-callback.html'
      }
    };

    let auth0Client = null;

    // Inicializar Auth0
    async function initAuth0() {
      auth0Client = await window.auth0.createAuth0Client(auth0Config);
      
      // Verificar se voltou do login
      const query = window.location.search;
      if (query.includes('code=') && query.includes('state=')) {
        await auth0Client.handleRedirectCallback();
        window.history.replaceState({}, document.title, '/auth0-login.html');
        await handleAuthCallback();
      }
    }

    // Fun√ß√µes de login
    window.loginWithMicrosoft = async function() {
      if (!auth0Client) return;
      
      showLoading(true);
      try {
        await auth0Client.loginWithRedirect({
          authorizationParams: {
            connection: 'windowslive' // Microsoft connection
          }
        });
      } catch (error) {
        console.error('Microsoft login failed:', error);
        showError('Microsoft login failed. Please try again.');
        showLoading(false);
      }
    };

    window.loginWithGoogle = async function() {
      if (!auth0Client) return;
      
      showLoading(true);
      try {
        await auth0Client.loginWithRedirect({
          authorizationParams: {
            connection: 'google-oauth2' // Google connection  
          }
        });
      } catch (error) {
        console.error('Google login failed:', error);
        showError('Google login failed. Please try again.');
        showLoading(false);
      }
    };

    // Processar callback do Auth0
    async function handleAuthCallback() {
      try {
        const user = await auth0Client.getUser();
        console.log('User logged in:', user);

        if (user) {
          // Criar sess√£o do usu√°rio
          const userSession = {
            id: user.sub,
            name: user.name || user.email,
            email: user.email,
            role: determineUserRole(user.email),
            photo: user.picture || getDefaultAvatar(),
            loginTime: new Date().toISOString(),
            provider: user.sub.includes('microsoft') ? 'microsoft' : 'google'
          };

          // Salvar na sess√£o
          sessionStorage.setItem('pethologyUser', JSON.stringify(userSession));

          // Salvar no Firebase para hist√≥rico
          await saveUserToFirebase(userSession);

          // Mostrar sucesso
          showSuccess(`Welcome, ${userSession.name}! Redirecting...`);

          // Redirecionar
          setTimeout(() => {
            if (userSession.role === 'Teacher') {
              window.location.href = 'teacher-dashboard.html';
            } else {
              window.location.href = 'student-dashboard.html';
            }
          }, 1500);
        }
      } catch (error) {
        console.error('Auth callback error:', error);
        showError('Login failed. Please try again.');
      }
    }

    // Salvar usu√°rio no Firebase
    async function saveUserToFirebase(userSession) {
      try {
        await setDoc(doc(db, 'users', userSession.id), {
          ...userSession,
          lastLogin: new Date(),
          updatedAt: new Date()
        }, { merge: true });
        console.log('User saved to Firebase');
      } catch (error) {
        console.error('Error saving user to Firebase:', error);
      }
    }

    // Determinar role do usu√°rio
    function determineUserRole(email) {
      if (!email) return 'Student';
      
      const emailLower = email.toLowerCase();
      
      if (emailLower.includes('staff') || 
          emailLower.includes('teacher') || 
          emailLower.includes('admin') ||
          emailLower.includes('instructor')) {
        return 'Teacher';
      }
      
      return 'Student';
    }

    // Avatar padr√£o
    function getDefaultAvatar() {
      return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="%234facfe"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
    }

    // UI helpers
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('success');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
    }

    // Demo users
    window.createDemoUser = function(type) {
      const demoUser = {
        id: 'demo-' + Date.now(),
        name: type === 'teacher' ? 'Professor Demo' : 'Student Demo',
        email: type === 'teacher' ? 'teacher@demo.com' : 'student@demo.com',
        role: type === 'teacher' ? 'Teacher' : 'Student',
        photo: getDefaultAvatar(),
        loginTime: new Date().toISOString(),
        provider: 'demo'
      };

      sessionStorage.setItem('pethologyUser', JSON.stringify(demoUser));
      showSuccess(`Demo ${type} created! Redirecting...`);

      setTimeout(() => {
        window.location.href = type === 'teacher' ? 'teacher-dashboard.html' : 'student-dashboard.html';
      }, 1000);
    };

    // Verificar se j√° est√° logado
    window.addEventListener('load', async () => {
      await initAuth0();
      
      const user = sessionStorage.getItem('pethologyUser');
      if (user) {
        const userData = JSON.parse(user);
        showSuccess(`Already logged in as ${userData.name}. Redirecting...`);

        setTimeout(() => {
          window.location.href = userData.role === 'Teacher' ? 'teacher-dashboard.html' : 'student-dashboard.html';
        }, 1500);
      }
    });
  </script>
</body>
</html>