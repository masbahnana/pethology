<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - Pethology</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/mobile-nav.css?v=5.1" />
  <style>
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      text-align: center;
    }

    .login-header {
      margin-bottom: 30px;
    }

    .login-header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #111;
    }

    .login-header p {
      color: #666;
      font-size: 1rem;
    }

    .microsoft-login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 15px 20px;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      margin-bottom: 10px;
    }
    
    .email-login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 15px 20px;
      background-color: #34a853;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      margin-bottom: 10px;
    }

    .email-login-btn:hover {
      background-color: #2d8e47;
      transform: translateY(-1px);
    }

    .microsoft-login-btn:hover {
      background-color: #106ebe;
      transform: translateY(-1px);
    }

    .google-login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 15px 20px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .google-login-btn:hover {
      background-color: #3367d6;
      transform: translateY(-1px);
    }

    .divider {
      margin: 20px 0;
      color: #999;
      font-size: 0.9rem;
    }

    .loading {
      display: none;
      margin-top: 20px;
      color: #666;
    }

    .error-message {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #fee;
      border: 1px solid #fcc;
      border-radius: 8px;
      color: #c33;
    }

    .success-message {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #efe;
      border: 1px solid #cfc;
      border-radius: 8px;
      color: #363;
    }

    .demo-users {
      margin-top: 30px;
      padding: 20px;
      background: #fff9e6;
      border-radius: 8px;
      border: 1px solid #ffd700;
    }

    .demo-users h4 {
      margin-top: 0;
      color: #b8860b;
    }

    .demo-button {
      display: inline-block;
      margin: 5px;
      padding: 8px 16px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      text-decoration: none;
      color: #333;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .demo-button:hover {
      background: #e0e0e0;
    }

    .info-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      text-align: left;
    }

    .info-section h3 {
      margin-top: 0;
      color: #111;
      font-size: 1.1rem;
    }

    .info-section ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .info-section li {
      margin-bottom: 5px;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <a href="index.html" class="logo">
        <img src="assets/img/pethology-logo.png" alt="Pethology Logo">
        <span class="logo-text">Pethology</span>
      </a>
    </div>
    <nav>
      <button class="menu-toggle" onclick="toggleMenu()" aria-label="Toggle menu">‚ò∞</button>
      <ul id="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="content.html">Content</a></li>
        <li><a href="quiz.html">Quiz</a></li>
        <li><a href="blog.html">Blog</a></li>
        <li><a href="students.html">For Students</a></li>
        <li><a href="teachers.html">For Teachers</a></li>
        <li><a href="support.html" class="support-button">Support Us</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="login-container">
      <div class="login-header">
        <img src="assets/img/pethology-logo.png" alt="Pethology Logo" style="height: 80px; margin: 0 auto 20px; display: block;">
        <h1>Welcome to Pethology!</h1>
        <p>Sign in to access your personalized learning experience</p>
      </div>

      <button class="microsoft-login-btn" onclick="loginAsStudent()" style="background: #3b82f6;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
        </svg>
        Student Login
      </button>

      <button class="email-login-btn" onclick="loginAsTeacher()" style="background: #8b5cf6;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
        </svg>
        Teacher Login
      </button>

      <div id="loading" class="loading">
        <p>Signing you in...</p>
      </div>

      <div id="error" class="error-message"></div>
      <div id="success" class="success-message"></div>

      <div class="info-section">
        <h3>‚úÖ How to Login</h3>
        <ul>
          <li><strong>Students:</strong> You must be pre-registered by your teacher. Use the email address your teacher added to the system.</li>
          <li><strong>Teachers:</strong> Contact the administrator to be added to the teacher whitelist.</li>
          <li><strong>Supported Accounts:</strong> Microsoft, Google, Outlook, and other email providers.</li>
          <li><strong>First Time?</strong> After login, you'll be redirected to the appropriate dashboard based on your role.</li>
        </ul>
      </div>

      <!-- Demo users for testing -->
      <div class="demo-users">
        <h4>üß™ Demo Mode</h4>
        <p>For testing and development:</p>
        <button class="demo-button" onclick="createDemoUser('student')">Demo Student</button>
        <button class="demo-button" onclick="createDemoUser('teacher')">Demo Teacher</button>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 Pethology ‚Äî Built with ‚ù§Ô∏è by Animal Care Nerds
  </footer>

  <!-- Auth0 SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>

  <!-- Firebase SDK for database -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // FIREBASE CONFIG (para banco de dados)
    const firebaseConfig = {
        apiKey: "AIzaSyDYq8xnfL9KPiKYHHvDG1zHDvjd4WAOO3o",
        authDomain: "pethology-7e9d7.firebaseapp.com",
        projectId: "pethology-7e9d7",
        storageBucket: "pethology-7e9d7.firebasestorage.app",
        messagingSenderId: "485201789422",
        appId: "1:485201789422:web:309a54ceb82588973f0eff"
    };

    // Inicializar Firebase (s√≥ para dados)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.firebaseDb = db;
    console.log('‚úÖ Firebase initialized');

    // AUTH0 CONFIG
    const auth0Config = {
      domain: 'dev-itl78pbpxq46x8gh.eu.auth0.com',
      clientId: 'uKYMTC50M5fOy3LemUcRnzNYCSgigclj',
      authorizationParams: {
        redirect_uri: window.location.origin + '/auth0-login.html'
      }
    };

    let auth0Client = null;

    // Inicializar Auth0
    async function initAuth0() {
      console.log('üîÑ Initializing Auth0...');
      auth0Client = await window.auth0.createAuth0Client(auth0Config);
      console.log('‚úÖ Auth0 initialized');
      
      // Verificar se voltou do login
      const query = window.location.search;
      if (query.includes('code=') && query.includes('state=')) {
        console.log('üîë Auth callback detected, processing...');
        await auth0Client.handleRedirectCallback();
        window.history.replaceState({}, document.title, '/auth0-login.html');
        await handleAuthCallback();
      }
    }
    
    // Fun√ß√µes de login
    window.loginWithMicrosoft = async function() {
      if (!auth0Client) return;
      
      showLoading(true);
      try {
        await auth0Client.loginWithRedirect({
          authorizationParams: {
            connection: 'windowslive'
          }
        });
      } catch (error) {
        console.error('Microsoft login failed:', error);
        showError('Microsoft login failed. Please try again.');
        showLoading(false);
      }
    };

    // Simplified login functions
    window.loginAsStudent = async function() {
      if (!auth0Client) return;

      showLoading(true);
      try {
        // Show universal login page - Auth0 will handle all providers
        await auth0Client.loginWithRedirect({
          authorizationParams: {
            prompt: 'login',
            screen_hint: 'signup'
          }
        });
      } catch (error) {
        console.error('Student login failed:', error);
        showError('Login failed. Please try again.');
        showLoading(false);
      }
    };

    window.loginAsTeacher = async function() {
      if (!auth0Client) return;

      showLoading(true);
      try {
        // Show universal login page - Auth0 will handle all providers
        await auth0Client.loginWithRedirect({
          authorizationParams: {
            prompt: 'login'
          }
        });
      } catch (error) {
        console.error('Teacher login failed:', error);
        showError('Login failed. Please try again.');
        showLoading(false);
      }
    };

    // Processar callback do Auth0
    async function handleAuthCallback() {
      console.log('üîÑ handleAuthCallback started');
      
      try {
        const user = await auth0Client.getUser();
        console.log('üë§ User obtained from Auth0:', user);

        if (user) {
          console.log('‚úÖ User exists, creating session...');
          
          // Criar sess√£o do usu√°rio
          const userSession = {
            id: user.sub,
            name: user.name || user.email,
            email: user.email,
            role: determineUserRole(user.email),
            photo: user.picture || getDefaultAvatar(),
            loginTime: new Date().toISOString(),
            provider: user.sub.includes('microsoft') ? 'microsoft' : 
                      user.sub.includes('google') ? 'google' : 'auth0'
          };

          console.log('üíæ UserSession created:', userSession);

          // Salvar na sess√£o
          sessionStorage.setItem('pethologyUser', JSON.stringify(userSession));
          console.log('‚úÖ Session saved to sessionStorage');

          // Salvar no Firebase para hist√≥rico
          console.log('üî• Calling saveUserToFirebase...');
          await saveUserToFirebase(userSession);
          console.log('‚úÖ After saveUserToFirebase');

          // Mostrar sucesso
          showSuccess(`Welcome, ${userSession.name}! Redirecting...`);

          // Redirecionar
          setTimeout(() => {
            if (userSession.role === 'Teacher') {
              window.location.href = 'teacher-dashboard.html'; // TEMPORARY: REST version
            } else {
              window.location.href = 'student-dashboard.html';
            }
          }, 1500);
        } else {
          console.warn('‚ö†Ô∏è No user data received from Auth0');
        }
      } catch (error) {
        console.error('‚ùå Auth callback error:', error);
        showError('Login failed. Please try again.');
      }
    }

    // Salvar usu√°rio no Firebase
    async function saveUserToFirebase(userSession) {
      console.log('üî• saveUserToFirebase called with:', userSession);
      
      try {
        console.log('üìù Attempting to save to Firestore...');
        
        await setDoc(doc(db, 'users', userSession.id), {
          ...userSession,
          lastLogin: new Date(),
          updatedAt: new Date()
        }, { merge: true });
        
        console.log('‚úÖ User successfully saved to Firebase!');
      } catch (error) {
        console.error('‚ùå Error saving user to Firebase:', error);
        console.error('Error details:', error.message);
        console.error('Error code:', error.code);
      }
    }

    // Determinar role do usu√°rio
    function determineUserRole(email) {
      if (!email) return 'Student';

      const emailLower = email.toLowerCase();

      // üë®‚Äçüè´ Lista espec√≠fica de Teachers (adicione seu email aqui!)
      const teacherEmails = [
        'plcnataliadasilvaraythz@plcstconlethcc365.ie', // Seu email!
        'teacher@demo.com',
        'nataliadasilvaraythz@outlook.com' // Se usar outlook
      ];

      if (teacherEmails.includes(emailLower)) {
        console.log('‚úÖ Email reconhecido como Teacher:', emailLower);
        return 'Teacher';
      }

      // Identifica√ß√£o autom√°tica por palavras-chave
      if (emailLower.includes('staff') ||
          emailLower.includes('teacher') ||
          emailLower.includes('admin') ||
          emailLower.includes('instructor')) {
        return 'Teacher';
      }

      // Estudantes: come√ßam com "plc" (mas n√£o est√£o na lista de teachers)
      if (emailLower.startsWith('plc')) {
        return 'Student';
      }

      // Por padr√£o, assume Student
      return 'Student';
    }

    // Avatar padr√£o
    function getDefaultAvatar() {
      return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="%234facfe"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
    }

    // UI helpers
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('success');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
    }

    // Demo users
    window.createDemoUser = function(type) {
      const demoUser = {
        id: 'demo-' + Date.now(),
        name: type === 'teacher' ? 'Professor Demo' : 'Student Demo',
        email: type === 'teacher' ? 'teacher@demo.com' : 'student@demo.com',
        role: type === 'teacher' ? 'Teacher' : 'Student',
        photo: getDefaultAvatar(),
        loginTime: new Date().toISOString(),
        provider: 'demo'
      };

      sessionStorage.setItem('pethologyUser', JSON.stringify(demoUser));
      showSuccess(`Demo ${type} created! Redirecting...`);

      setTimeout(() => {
        window.location.href = type === 'teacher' ? 'teacher-dashboard.html' : 'student-dashboard.html'; // TEMPORARY: REST version
      }, 1000);
    };

    // Verificar se j√° est√° logado
    window.addEventListener('load', async () => {
      console.log('üöÄ Page loaded, initializing...');
      await initAuth0();
      
      const user = sessionStorage.getItem('pethologyUser');
      if (user) {
        const userData = JSON.parse(user);
        console.log('üë§ User already logged in:', userData);
        showSuccess(`Already logged in as ${userData.name}. Redirecting...`);

        setTimeout(() => {
          window.location.href = userData.role === 'Teacher' ? 'teacher-dashboard.html' : 'student-dashboard.html'; // TEMPORARY: REST version
        }, 1500);
      }
    });
  </script>
  <script src="assets/js/mobile-nav.js"></script>
</body>
</html>