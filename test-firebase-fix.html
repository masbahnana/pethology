<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Fix Test - v4db24d3</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .status-box {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success { color: #059669; }
    .error { color: #dc2626; }
    .warning { color: #d97706; }
    pre {
      background: #1f2937;
      color: #f3f4f6;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #4f46e5;
    }
    .test-result {
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 4px;
      background: #f3f4f6;
    }
  </style>
</head>
<body>
  <h1>üî• Firebase Fix Test - Version 4db24d3</h1>

  <div class="status-box">
    <h2>üìä Test Status</h2>
    <div id="testResults"></div>
    <button onclick="runTests()">Run Tests</button>
    <button onclick="clearAllCache()">Clear All Cache</button>
    <button onclick="testButtonClick()">Test Button Click</button>
  </div>

  <div class="status-box">
    <h2>üìù Console Output</h2>
    <pre id="consoleOutput">Waiting for tests...</pre>
  </div>

  <div class="status-box">
    <h2>üéØ Expected Results</h2>
    <ul>
      <li class="success">‚úÖ Should see: "üî• Firebase initialized with REST mode (no WebChannel)"</li>
      <li class="success">‚úÖ Should see: Firebase version 10.7.1</li>
      <li class="success">‚úÖ Buttons should be clickable (cursor changes to pointer)</li>
      <li class="error">‚ùå Should NOT see: "firestore.googleapis.com/Listen/channel" errors</li>
      <li class="error">‚ùå Should NOT see: CORS errors</li>
    </ul>
  </div>

  <script type="module">
    // FORCE FRESH IMPORT - Add timestamp to bypass cache
    const timestamp = Date.now();
    const FirebaseModule = await import(`./assets/js/firebase-service.js?v=${timestamp}`);
    const PethologyFirebaseService = FirebaseModule.PethologyFirebaseService;

    window.PethologyFirebaseService = PethologyFirebaseService;

    const output = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      output.push(`[${timestamp}] ${message}`);
      document.getElementById('consoleOutput').textContent = output.join('\n');

      if (type === 'success') console.log('‚úÖ', message);
      else if (type === 'error') console.error('‚ùå', message);
      else if (type === 'warning') console.warn('‚ö†Ô∏è', message);
      else console.log(message);
    }

    log('üî• Starting Firebase diagnostics...', 'info');
    log(`Cache-busting timestamp: ${timestamp}`, 'info');

    window.runTests = async function() {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = '<p>Running tests...</p>';
      output.length = 0; // Clear output

      try {
        log('TEST 1: Checking Firebase initialization...', 'info');

        // Test 1: Check if Firebase is initialized
        if (window.PethologyFirebaseService) {
          log('‚úÖ PethologyFirebaseService loaded successfully', 'success');
          addResult('‚úÖ Firebase Service Loaded', true);
        } else {
          log('‚ùå PethologyFirebaseService not found!', 'error');
          addResult('‚ùå Firebase Service NOT Loaded', false);
          return;
        }

        // Test 2: Try to fetch students (simple query)
        log('TEST 2: Fetching students from Firebase...', 'info');
        const startTime = Date.now();

        try {
          const students = await Promise.race([
            PethologyFirebaseService.getAllStudents(),
            new Promise((_, reject) =>
              setTimeout(() => reject(new Error('Timeout after 10s')), 10000)
            )
          ]);

          const elapsed = Date.now() - startTime;
          log(`‚úÖ Fetched ${students.length} students in ${elapsed}ms`, 'success');
          addResult(`‚úÖ Firebase Query Success (${elapsed}ms)`, true);

          // Test 3: Check for CORS errors in console
          log('TEST 3: Checking for CORS errors...', 'info');
          log('‚ö†Ô∏è Check browser console manually for CORS errors', 'warning');
          addResult('‚ö†Ô∏è Check Console for CORS Errors', null);

        } catch (error) {
          log(`‚ùå Firebase query failed: ${error.message}`, 'error');
          addResult(`‚ùå Firebase Query Failed: ${error.message}`, false);

          if (error.message.includes('CORS')) {
            log('‚ùå CORS ERROR DETECTED - WebChannel still active!', 'error');
            addResult('‚ùå CORS ERROR - Cache problem!', false);
          }
        }

        log('‚úÖ All tests completed!', 'success');

      } catch (error) {
        log(`‚ùå Test suite error: ${error.message}`, 'error');
        addResult(`‚ùå Test Suite Error: ${error.message}`, false);
      }
    };

    function addResult(message, success) {
      const resultsDiv = document.getElementById('testResults');
      const resultEl = document.createElement('div');
      resultEl.className = 'test-result';

      if (success === true) resultEl.style.background = '#d1fae5';
      else if (success === false) resultEl.style.background = '#fee2e2';
      else resultEl.style.background = '#fef3c7';

      resultEl.textContent = message;
      resultsDiv.appendChild(resultEl);
    }

    window.clearAllCache = function() {
      log('üßπ Clearing all cache...', 'info');

      // Clear localStorage
      localStorage.clear();
      log('‚úÖ localStorage cleared', 'success');

      // Clear sessionStorage
      sessionStorage.clear();
      log('‚úÖ sessionStorage cleared', 'success');

      // Try to unregister service workers
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(reg => reg.unregister());
          log('‚úÖ Service workers unregistered', 'success');
        });
      }

      log('üîÑ Please do HARD REFRESH now: Cmd+Shift+R (Mac) or Ctrl+Shift+R (Windows)', 'warning');
      alert('Cache cleared! Now do a HARD REFRESH:\n\nMac: Cmd+Shift+R\nWindows: Ctrl+Shift+R\n\nOr close tab and reopen.');
    };

    window.testButtonClick = function() {
      log('üñ±Ô∏è Button click test successful!', 'success');
      addResult('‚úÖ Button Click Works!', true);
      alert('‚úÖ Button is clickable! This is good.');
    };

    // Auto-run tests on load
    log('Page loaded successfully', 'success');
    log('Click "Run Tests" to start diagnostics', 'info');

  </script>
</body>
</html>
