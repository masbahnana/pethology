<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Content | Pethology</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="assets/css/mobile-nav.css?v=5.1" />
  <link rel="icon" href="assets/img/pethology-logo.png" type="image/png" />
</head>

<body>
  <header>
    <a href="index.html" class="logo">
      <img src="assets/img/pethology-logo.png" alt="Pethology Logo">
      <span class="logo-text">Pethology</span>
    </a>
    <nav>
      <button class="menu-toggle" onclick="toggleMenu()" aria-label="Toggle menu">‚ò∞</button>
      <ul id="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="content.html" class="active">Content</a></li>
        <li><a href="quiz.html">Quiz</a></li>
        <li><a href="blog.html">Blog</a></li>
        <li><a href="support.html" class="support-button">Support Us</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="page-container">
      <div class="card">
        <h1 class="page-title">Explore Our Modules</h1>
  
        <div class="quiz-container">
          <button class="minimal-button" onclick="toggleTopics('biology-topics', this)">
            Biology <span class="arrow">‚åÑ</span>
          </button>
          <ul id="biology-topics" class="topic-list">
            <li><button class="minimal-button" onclick="loadMarkdown('cell.md')">Cell Structure</button></li>
          </ul>

        </div>
  
        <div class="markdown-content" id="markdown-content">
          <p></p>
        </div>

        <!-- Extra Readings from Teachers -->
        <div id="extraReadingsSection" style="margin-top: 48px; display: none;">
          <h2 style="font-size: 1.8rem; font-weight: 700; color: #111827; margin-bottom: 24px; border-bottom: 3px solid #667eea; padding-bottom: 12px;">
            üìö Extra Readings from Your Teacher
          </h2>
          <div id="extraReadingsContainer">
            <p style="color: #6b7280;">Loading extra readings...</p>
          </div>
        </div>

        <div class="login-message" id="loginMessage">
          <p>üîí Log in to view personalized content from your teacher.</p>
        </div>
      </div>
    </div>
  </main>

  <footer>
    &copy; 2025 Pethology ‚Äî Built with ‚ù§Ô∏è by Animal Care Nerds
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="assets/js/content.js"></script>

  <script type="module">
    import { PethologyFirebaseService } from './assets/js/firebase-service.js';

    // Check if user is logged in and load extra readings
    window.addEventListener('DOMContentLoaded', async () => {
      const userSession = sessionStorage.getItem('pethologyUser');

      if (userSession) {
        console.log('‚úÖ User logged in, loading extra readings...');

        // Hide login message
        document.getElementById('loginMessage').style.display = 'none';

        // Show and load extra readings
        await loadExtraReadings();
      } else {
        console.log('‚ÑπÔ∏è User not logged in, showing login message');
      }
    });

    async function loadExtraReadings() {
      const section = document.getElementById('extraReadingsSection');
      const container = document.getElementById('extraReadingsContainer');

      section.style.display = 'block';

      try {
        const content = await PethologyFirebaseService.getAllContent();
        console.log(`üìö Loaded ${content.length} extra readings`);

        if (content.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 48px; color: #6b7280;">
              <div style="font-size: 3rem; margin-bottom: 12px; opacity: 0.5;">üìö</div>
              <p>No extra readings available yet.<br>Your teacher will publish content here soon!</p>
            </div>
          `;
          return;
        }

        // Group content by module
        const contentByModule = groupByModule(content);

        let html = '';
        for (const [moduleName, items] of Object.entries(contentByModule)) {
          html += `
            <div style="margin-bottom: 32px;">
              <h3 style="font-size: 1.3rem; font-weight: 600; color: #374151; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                ${getModuleIcon(moduleName)} ${getModuleName(moduleName)}
                <span style="background: #e5e7eb; color: #6b7280; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 500;">
                  ${items.length} reading${items.length !== 1 ? 's' : ''}
                </span>
              </h3>
              <div style="display: grid; gap: 16px;">
                ${items.map(item => `
                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer;"
                       onclick="showReading('${item.id}', ${JSON.stringify(item.title).replace(/'/g, "&#39;")})">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                      <h4 style="font-size: 1.1rem; font-weight: 600; color: #111827; margin: 0;">
                        ${getTypeIcon(item.type)} ${item.title}
                      </h4>
                      <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; margin-left: 12px;">
                        ${getTypeName(item.type)}
                      </span>
                    </div>
                    ${item.author ? `
                      <p style="color: #6b7280; font-size: 0.9rem; margin: 4px 0 0 0;">
                        By ${item.author} ‚Ä¢ ${formatDate(item.createdAt)}
                      </p>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        container.innerHTML = html;
      } catch (error) {
        console.error('‚ùå Error loading extra readings:', error);
        container.innerHTML = `
          <div style="background: #fee2e2; color: #991b1b; padding: 16px; border-radius: 12px;">
            <strong>Error loading extra readings.</strong> Please refresh the page.
          </div>
        `;
      }
    }

    // Show reading in the markdown content area
    window.showReading = function(contentId, title) {
      console.log('üìñ Showing reading:', contentId);

      // Fetch content by ID and display
      PethologyFirebaseService.getAllContent().then(contents => {
        const content = contents.find(c => c.id === contentId);
        if (content) {
          const markdownContent = document.getElementById('markdown-content');
          markdownContent.innerHTML = marked.parse(content.body);

          // Scroll to content
          markdownContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    };

    function groupByModule(content) {
      const grouped = {};
      content.forEach(item => {
        const module = item.module || 'other';
        if (!grouped[module]) {
          grouped[module] = [];
        }
        grouped[module].push(item);
      });
      return grouped;
    }

    function getModuleName(moduleKey) {
      const moduleNames = {
        'biology': 'Biology',
        'animal-welfare': 'Animal Welfare',
        'animal-anatomy': 'Animal Anatomy & Physiology',
        'grooming': 'Grooming & Husbandry',
        'small-animals': 'Small Animals H&H',
        'animal-behaviour': 'Animal Behaviour',
        'vet-assistant': 'Vet Assistant Skills',
        'word-processing': 'Word Processing'
      };
      return moduleNames[moduleKey] || moduleKey;
    }

    function getModuleIcon(moduleKey) {
      const icons = {
        'biology': 'üß¨',
        'animal-welfare': 'üêæ',
        'animal-anatomy': 'ü¶¥',
        'grooming': '‚úÇÔ∏è',
        'small-animals': 'üêπ',
        'animal-behaviour': 'üêï',
        'vet-assistant': 'üè•',
        'word-processing': 'üíª'
      };
      return icons[moduleKey] || 'üìö';
    }

    function getTypeName(type) {
      const types = {
        'reading': 'Reading',
        'video': 'Video',
        'exercise': 'Exercise',
        'reference': 'Reference'
      };
      return types[type] || type;
    }

    function getTypeIcon(type) {
      const icons = {
        'reading': 'üìñ',
        'video': 'üé•',
        'exercise': '‚úèÔ∏è',
        'reference': 'üìö'
      };
      return icons[type] || 'üìÑ';
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown date';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }
  </script>
  <script src="assets/js/mobile-nav.js"></script>
</body>
</html>
